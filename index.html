<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Ambition Tracker — Lokal</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --card-bg: #fff;
      --muted: #666;
      --accent: linear-gradient(90deg,#4caf50,#81c784);
      --radius: 10px;
    }
    body { font-family: Inter, system-ui, sans-serif; padding: 18px; max-width: 1040px; margin: auto; background:#f5f7fb; color:#222; }
    header { display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:12px; }
    h1 { margin:0; font-size:1.25rem; display:flex; gap:8px; align-items:center; }
    .controls { display:flex; gap:8px; align-items:center; }
    .card { background:var(--card-bg); border-radius:var(--radius); padding:12px; box-shadow:0 6px 18px rgba(20,30,40,0.06); }
    .xp-bar { margin:10px 0; }
    .progress-bar { height:22px; background:#eee; border-radius:12px; overflow:hidden; }
    .progress-bar-inner { height:100%; width:0%; transition: width .45s; background:var(--accent); }
    #rewards { margin-top:8px; display:flex; flex-wrap:wrap; gap:6px; }
    .badge { padding:6px 10px; border-radius:999px; background:gold; font-weight:600; box-shadow:0 2px 6px rgba(0,0,0,.06); }
    #dashboard { margin-top:14px; display:grid; grid-template-columns: repeat(auto-fit,minmax(260px,1fr)); gap:12px; }
    .goal { padding:10px; border-radius:10px; position:relative; min-height:120px; display:flex; flex-direction:column; gap:8px; }
    .goal h3 { margin:0; display:flex; gap:8px; align-items:center; font-size:1rem; }
    .goal .meta { font-size:0.9rem; color:var(--muted); display:flex; gap:8px; align-items:center; }
    .goal .actions { margin-top:auto; display:flex; gap:6px; flex-wrap:wrap; }
    button { cursor:pointer; border:0; padding:8px 10px; border-radius:8px; background:#eef2f6; }
    .small { padding:6px 8px; font-size:.9rem; }
    .heatmap { display:grid; grid-template-columns: repeat(7, 14px); gap:4px; margin-top:8px; }
    .day { width:14px; height:14px; background:#eee; border-radius:3px; box-shadow: inset 0 -2px 0 rgba(0,0,0,0.03); }
    .day[data-count="1"] { background:#c8e6c9; }
    .day[data-count="2"] { background:#a5d6a7; }
    .day[data-count="3"] { background:#81c784; }
    .day[data-count="4"] { background:#388e3c; }
    .day[data-count="5"] { background:#1b5e20; }
    .goal-settings { position:absolute; top:8px; right:8px; display:flex; gap:6px; }
    .goal img.icon { width:28px; height:28px; border-radius:6px; object-fit:cover; }
    footer { margin-top:18px; display:flex; justify-content:space-between; gap:8px; align-items:center; color:var(--muted); }
    .rewards-log { max-height:120px; overflow:auto; padding:8px; border-radius:8px; background:#fff; }
    input[type="file"] { display:block; }
    .modal { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.35); z-index:50; }
    .modal .card { width:520px; max-width:94%; }
    label { display:block; margin-top:8px; font-weight:600; font-size:.9rem; margin-bottom:6px; }
    .row { display:flex; gap:8px; align-items:center; }
    .tiny { font-size:.85rem; color:var(--muted); }
    .danger { background:#ffdede; }
    .muted-btn{ background:transparent; border:1px dashed #d7dbe0; }
    @media (max-width:520px){
      .heatmap { grid-template-columns: repeat(7, 11px); gap:3px; }
      .day { width:11px; height:11px; }
    }
  </style>
</head>
<body>
  <header>
    <h1>🎯 Ambition Tracker (Lokal)</h1>
    <div class="controls">
      <label for="user-select">User:</label>
      <select id="user-select" class="small"></select>
      <button id="add-user" title="Neuen User anlegen">➕ Add User</button>
      <button id="export-data" title="Daten exportieren">⬇ Export</button>
      <button id="import-data" title="Daten importieren">⬆ Import</button>
    </div>
  </header>

  <section class="card xp-bar">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <div>
        <strong id="user-name">User1</strong>
        <div id="xp-info" class="tiny">XP: 0 / 10 (Level 1)</div>
      </div>
      <div style="text-align:right;">
        <div id="streak-info" class="tiny">🔥 Streak: 0 Tage</div>
        <div id="user-level" class="tiny">Level: 1</div>
      </div>
    </div>
    <div style="margin-top:8px;">
      <div class="progress-bar"><div id="xp-bar-inner" class="progress-bar-inner"></div></div>
      <div id="rewards" aria-live="polite"></div>
    </div>
  </section>

  <div style="display:flex; gap:12px; align-items:flex-start; margin-top:12px;">
    <div style="flex:1">
      <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
        <h2 style="margin:0">Ziele</h2>
        <button id="add-goal">➕ Add Goal</button>
      </div>

      <div id="dashboard"></div>
    </div>

    <aside style="width:320px;">
      <div class="card">
        <h3 style="margin-top:0">Belohnungen (Log)</h3>
        <div id="rewards-log" class="rewards-log"></div>
        <div style="margin-top:10px;">
          <strong>Pools</strong>
          <div class="tiny" style="margin-top:6px;">
            Normale Belohnungen: <span id="pool-normal" class="tiny"></span><br>
            Besondere Belohnungen: <span id="pool-special" class="tiny"></span>
          </div>
        </div>
      </div>
    </aside>
  </div>

  <footer>
    <div class="tiny">Speichert lokal in deinem Browser (localStorage).</div>
    <div class="tiny">Letztes Backup: <span id="last-backup">—</span></div>
  </footer>

  <!-- Modal Template -->
  <div id="modal-root" style="display:none;"></div>

  <script>
    // -------------------------
    // Lokale Speicherung ONLY
    // -------------------------
    const STORAGE_KEY = "ambition-tracker-users-v1";
    const XP_PER_LEVEL = 10;
    const DEFAULT_USER = "User1";

    // --- Belohnungspools ---
    const normalRewards = ["🍬 Süßigkeit", "☕ Kaffee-Pause", "📱 5 Min Handy", "🎵 Musik hören", "🍪 Keks", "🍫 Schoki", "🧋 Snack"];
    const specialRewards = ["🎁 Besonderes Geschenk", "🏆 Gold-Medaille", "🎮 Extra Gaming-Zeit", "📖 Neues Buch", "🍷 Feierabend-Genuss", "🎟️ Kinoabend"];

    // --- State ---
    let users = {};
    let currentUser = DEFAULT_USER;
    let modal = null;

    // --- Helpers: Load/Save ---
    function loadLocalUsers(){
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        users = raw ? JSON.parse(raw) : {};
      } catch(e){
        console.error("Fehler beim Laden:", e);
        users = {};
      }
    }
    function saveLocalUsers(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(users));
    }

    // --- Default User / Data Model ---
    function createDefaultUser(username){
      return {
        name: username,
        totalXP: 0,
        currentLevel: 1,
        rewards: [],
        goals: [
          { id: 1, name: "Read 20 pages", target: 20, progress: 0, lastUpdate: null, decayRate: 0, color:"#ffffff", emoji:"📘", imgData:null, activityLog: {} }
        ],
        streak: 0,
        lastActive: null,
        settings: { bgColor: "#ffffff" },
        log: [] // chronological events, e.g. rewards
      };
    }

    // --- Init and UI wiring ---
    function init(){
      loadLocalUsers();
      if(!users[DEFAULT_USER]) users[DEFAULT_USER] = createDefaultUser(DEFAULT_USER);
      if(!users[DEFAULT_USER].goals || users[DEFAULT_USER].goals.length === 0) users[DEFAULT_USER].goals = [createDefaultUser(DEFAULT_USER).goals[0]];
      // pick currentUser if saved
      const savedUser = localStorage.getItem(STORAGE_KEY + "-current");
      if(savedUser && users[savedUser]) currentUser = savedUser;
      renderAll();
      attachEvents();
      updatePoolsUI();
    }

    // --- Utility: unique id for goals ---
    function nextGoalId(user){
      const g = users[user].goals;
      return g.length ? (Math.max(...g.map(x=>x.id)) + 1) : 1;
    }

    // --- XP & Rewards logic ---
    function addXPToUser(user, amount){
      const data = users[user];
      const today = new Date().toISOString().split("T")[0];
      if (data.lastActive){
        const diff = Math.round((new Date(today) - new Date(data.lastActive)) / (1000*60*60*24));
        if (diff === 1) data.streak++;
        else if (diff > 1) data.streak = 1;
      } else {
        data.streak = 1;
      }
      data.lastActive = today;

      let multiplier = data.streak >= 5 ? 2 : 1;
      data.totalXP += amount * multiplier;

      const newLevel = Math.floor(data.totalXP / XP_PER_LEVEL) + 1;
      if (newLevel > data.currentLevel){
        // leveled up
        const oldLevel = data.currentLevel;
        data.currentLevel = newLevel;

        // normale Belohnung
        const reward = normalRewards[Math.floor(Math.random()*normalRewards.length)];
        data.rewards.push(reward);
        data.log.unshift({ts: new Date().toISOString(), text: `Level ${newLevel}: ${reward}`});

        // besondere Belohnung für besondere Level (5,10,20,30,... -> hier jede 5)
        if (newLevel % 5 === 0){
          const special = specialRewards[Math.floor(Math.random()*specialRewards.length)];
          data.rewards.push(special);
          data.log.unshift({ts: new Date().toISOString(), text: `🎯 Special Level ${newLevel}: ${special}`});
        }

        alert(`🎉 Level ${newLevel} erreicht! Schau dir das Belohnungs-Log an.`);
      }
      saveLocalUsers();
      renderAll();
    }

    // --- Goal progress & heatmap logging ---
    function progressGoal(goalId, amount){
      const data = users[currentUser];
      const goal = data.goals.find(g => g.id === goalId);
      if (!goal) return;
      goal.progress = (goal.progress || 0) + amount;
      goal.lastUpdate = new Date().toISOString().split("T")[0];

      // log activity for this goal (date => amount)
      const today = new Date().toISOString().split("T")[0];
      goal.activityLog[today] = (goal.activityLog[today] || 0) + amount;

      // add xp to user
      addXPToUser(currentUser, amount);

      saveLocalUsers();
      renderAll();
    }

    // --- Goal settings modal ---
    function openGoalSettings(goalId){
      const data = users[currentUser];
      const goal = data.goals.find(g => g.id === goalId);
      if(!goal) return;
      showModal(`
        <h3>Einstellungen: ${escapeHtml(goal.name)}</h3>
        <label>Farbe</label>
        <input id="goal-color" type="color" value="${goal.color || '#ffffff'}" />
        <label>Emoji / Icon (z.B. 🎯 oder 🔥)</label>
        <input id="goal-emoji" type="text" maxlength="4" value="${goal.emoji || ''}" />
        <label>Bild (per Upload)</label>
        <input id="goal-img-file" type="file" accept="image/*" />
        <label>Oder Bild-URL</label>
        <input id="goal-img-url" type="text" placeholder="https://..." value="${goal.imgData && goal.imgData.startsWith('data:') ? '' : (goal.imgData || '')}" />
        <div style="margin-top:10px; display:flex; gap:8px; justify-content:flex-end;">
          <button id="delete-img" class="muted-btn">Bild entfernen</button>
          <button id="save-goal" class="small">Speichern</button>
          <button id="close-modal" class="small">Abbrechen</button>
        </div>
      `);

      // file handling
      const fileInput = document.getElementById('goal-img-file');
      fileInput.addEventListener('change', (e)=>{
        const f = e.target.files[0];
        if(!f) return;
        const reader = new FileReader();
        reader.onload = () => {
          // store data URL temporarily in a hidden input so save handler can pick it up
          document.getElementById('goal-img-url').value = reader.result;
        };
        reader.readAsDataURL(f);
      });

      document.getElementById('delete-img').addEventListener('click', ()=>{
        document.getElementById('goal-img-url').value = '';
      });

      document.getElementById('save-goal').addEventListener('click', ()=>{
        const newColor = document.getElementById('goal-color').value;
        const newEmoji = document.getElementById('goal-emoji').value || '';
        const newImg = document.getElementById('goal-img-url').value || null;
        goal.color = newColor;
        goal.emoji = newEmoji;
        goal.imgData = newImg;
        saveLocalUsers();
        closeModal();
        renderAll();
      });

      document.getElementById('close-modal').addEventListener('click', closeModal);
    }

    // --- UI Renderers ---
    function renderAll(){
      renderUserSelect();
      renderHeader();
      renderGoals();
      renderRewardsLog();
      saveLocalUsers();
      localStorage.setItem(STORAGE_KEY + "-current", currentUser);
    }

    function renderHeader(){
      const data = users[currentUser];
      document.getElementById('user-name').textContent = data.name;
      const xpInLevel = data.totalXP % XP_PER_LEVEL;
      document.getElementById('xp-info').textContent = `XP: ${xpInLevel} / ${XP_PER_LEVEL} (Level ${data.currentLevel})`;
      document.getElementById('streak-info').textContent = `🔥 Streak: ${data.streak || 0} Tage`;
      document.getElementById('user-level').textContent = `Level: ${data.currentLevel}`;
      const percent = Math.round((xpInLevel / XP_PER_LEVEL) * 100);
      document.getElementById('xp-bar-inner').style.width = percent + '%';

      // show last backup info if any
      const lastBackup = localStorage.getItem(STORAGE_KEY + "-last-backup") || "—";
      document.getElementById('last-backup').textContent = lastBackup;
    }

    function renderUserSelect(){
      const sel = document.getElementById('user-select');
      sel.innerHTML = '';
      Object.keys(users).forEach(u=>{
        const opt = document.createElement('option');
        opt.value = u; opt.textContent = u;
        if(u === currentUser) opt.selected = true;
        sel.appendChild(opt);
      });
    }

    function renderGoals(){
      const container = document.getElementById('dashboard');
      container.innerHTML = '';
      const data = users[currentUser];
      data.goals.forEach(goal => {
        const card = document.createElement('div');
        card.className = 'card goal';
        card.style.background = goal.color || '#fff';

        // header with emoji / image
        const h = document.createElement('h3');
        if (goal.imgData){
          const img = document.createElement('img');
          img.src = goal.imgData;
          img.className = 'icon';
          h.appendChild(img);
        } else if (goal.emoji){
          const span = document.createElement('span');
          span.textContent = goal.emoji + ' ';
          h.appendChild(span);
        }
        const title = document.createElement('span');
        title.textContent = goal.name;
        h.appendChild(title);

        // meta
        const meta = document.createElement('div');
        meta.className = 'meta';
        meta.innerHTML = `Progress: <strong>${Math.floor(goal.progress || 0)}</strong> / ${goal.target} &nbsp;•&nbsp; Decay: ${goal.decayRate || 0}/Tag`;

        // heatmap (last 30 days for this goal)
        const heat = renderGoalHeatmap(goal);

        // actions
        const actions = document.createElement('div');
        actions.className = 'actions';
        actions.innerHTML = `
          <button class="small" data-goal="${goal.id}" data-amt="1">+1</button>
          <button class="small" data-goal="${goal.id}" data-amt="2">+2</button>
          <button class="small" data-goal="${goal.id}" data-amt="5">+5</button>
          <button class="small" data-edit="${goal.id}">⚙</button>
        `;

        // attach handler for progress buttons
        actions.querySelectorAll('button[data-goal]').forEach(b=>{
          b.addEventListener('click', ()=>{
            const gid = Number(b.getAttribute('data-goal'));
            const a = Number(b.getAttribute('data-amt'));
            progressGoal(gid, a);
          });
        });

        // settings button
        actions.querySelectorAll('button[data-edit]').forEach(b=>{
          b.addEventListener('click', ()=>{
            const gid = Number(b.getAttribute('data-edit'));
            openGoalSettings(gid);
          });
        });

        // assemble
        card.appendChild(h);
        card.appendChild(meta);
        card.appendChild(actions);
        card.appendChild(heat);
        container.appendChild(card);
      });
    }

    function renderGoalHeatmap(goal){
      const container = document.createElement('div');
      container.className = 'heatmap';
      const today = new Date();
      for (let i = 29; i >= 0; i--){
        const d = new Date(today);
        d.setDate(d.getDate() - i);
        const key = d.toISOString().split('T')[0];
        const count = goal.activityLog && goal.activityLog[key] ? Math.min(goal.activityLog[key], 5) : 0;
        const div = document.createElement('div');
        div.className = 'day';
        if (count > 0) div.dataset.count = String(count);
        container.appendChild(div);
      }
      return container;
    }

    function renderRewardsLog(){
      const el = document.getElementById('rewards-log');
      el.innerHTML = '';
      const data = users[currentUser];
      if(!data || !data.log) { el.textContent = 'Keine Belohnungen bisher.'; return; }
      if(data.log.length === 0) { el.textContent = 'Keine Belohnungen bisher.'; return; }
      data.log.forEach(item=>{
        const row = document.createElement('div');
        row.style.padding = '6px 4px';
        row.style.borderBottom = '1px solid #f1f3f5';
        row.innerHTML = `<div style="font-weight:600">${escapeHtml(item.text)}</div><div class="tiny">${(new Date(item.ts)).toLocaleString()}</div>`;
        el.appendChild(row);
      });
    }

    function updatePoolsUI(){
      document.getElementById('pool-normal').textContent = normalRewards.join(', ');
      document.getElementById('pool-special').textContent = specialRewards.join(', ');
      // show a few recent rewards as badges
      const badges = document.getElementById('rewards');
      badges.innerHTML = '';
      const recent = users[currentUser] ? (users[currentUser].rewards || []).slice(-6).reverse() : [];
      recent.forEach(r => {
        const s = document.createElement('span');
        s.className = 'badge';
        s.textContent = r;
        badges.appendChild(s);
      });
    }

    // --- Modal helpers ---
    function showModal(innerHtml){
      const root = document.getElementById('modal-root');
      root.style.display = 'block';
      root.innerHTML = `<div class="modal"><div class="card">${innerHtml}</div></div>`;
      modal = root;
      root.querySelector('.modal').addEventListener('click', (e)=>{
        if(e.target === root.querySelector('.modal')) closeModal();
      });
    }
    function closeModal(){ 
      const root = document.getElementById('modal-root');
      root.style.display = 'none';
      root.innerHTML = '';
      modal = null;
    }

    // --- Events: Add user, add goal, export/import ---
    function attachEvents(){
      document.getElementById('add-user').addEventListener('click', ()=>{
        const name = prompt("Neuer Username:");
        if(!name) return;
        if(users[name]) { alert("User existiert bereits."); return; }
        users[name] = createDefaultUser(name);
        currentUser = name;
        saveLocalUsers();
        renderAll();
      });

      document.getElementById('user-select').addEventListener('change', (e)=>{
        const v = e.target.value;
        if(users[v]) currentUser = v;
        renderAll();
      });

      document.getElementById('add-goal').addEventListener('click', ()=>{
        const name = prompt("Name des Ziels:");
        if(!name) return;
        const target = parseInt(prompt("Ziel (Anzahl / units):", "10"), 10) || 10;
        const decay = parseFloat(prompt("Decay pro Tag (0 = none):", "0")) || 0;
        const id = nextGoalId(currentUser);
        users[currentUser].goals.push({ id, name, target, progress:0, lastUpdate:null, decayRate: decay, color:'#ffffff', emoji:'🎯', imgData:null, activityLog:{} });
        saveLocalUsers();
        renderAll();
      });

      // export
      document.getElementById('export-data').addEventListener('click', ()=>{
        const payload = JSON.stringify(users, null, 2);
        const blob = new Blob([payload], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `ambition-tracker-backup-${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        localStorage.setItem(STORAGE_KEY + "-last-backup", new Date().toISOString());
        renderAll();
        alert("Export gestartet (Download).");
      });

      // import
      document.getElementById('import-data').addEventListener('click', ()=>{
        showModal(`
          <h3>Daten importieren (JSON)</h3>
          <p class="tiny">Wähle eine JSON-Datei, die zuvor als Backup exportiert wurde.</p>
          <input id="import-file" type="file" accept="application/json" />
          <div style="margin-top:10px; display:flex; gap:8px; justify-content:flex-end;">
            <button id="do-import" class="small">Importieren</button>
            <button id="cancel-import" class="small">Abbrechen</button>
          </div>
        `);
        document.getElementById('cancel-import').addEventListener('click', closeModal);
        document.getElementById('do-import').addEventListener('click', ()=>{
          const f = document.getElementById('import-file').files[0];
          if(!f){ alert("Keine Datei ausgewählt"); return; }
          const reader = new FileReader();
          reader.onload = ()=>{
            try {
              const parsed = JSON.parse(reader.result);
              // optional: basic sanity check
              if(typeof parsed !== 'object') throw new Error("Ungültiges Format.");
              Object.assign(users, parsed);
              saveLocalUsers();
              closeModal();
              renderAll();
              alert("Import erfolgreich.");
            } catch(e){
              alert("Fehler beim Import: " + e.message);
            }
          };
          reader.readAsText(f);
        });
      });
    }

    // --- small escape helper ---
    function escapeHtml(s){
      if(!s) return '';
      return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    // --- start ---
    init();

    // Update small UI pieces after render
    setInterval(()=>{ updatePoolsUI(); }, 2000);

    // expose progressGoal on window so inline handlers work if used
    window.progressGoal = progressGoal;
    window.openGoalSettings = openGoalSettings;
  </script>
</body>
</html>
