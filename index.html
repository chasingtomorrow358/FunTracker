<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Ambition Tracker Hybrid</title>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 900px; margin: auto; }
    h1 { text-align: center; }
    .xp-bar { margin: 20px 0; }
    .progress-bar { height: 25px; background: #eee; border-radius: 12px; overflow: hidden; }
    .progress-bar-inner { height: 100%; background: linear-gradient(90deg, #4caf50, #81c784); width: 0%; transition: width 0.5s; }
    .goal { margin-bottom: 20px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
    .badge { display: inline-block; margin: 5px; padding: 6px 10px; background: gold; border-radius: 12px; font-weight: bold; }
    .heatmap { display: grid; grid-template-columns: repeat(7, 20px); gap: 3px; margin-top: 10px; }
    .day { width: 20px; height: 20px; background: #eee; border-radius: 3px; }
    .day[data-count="1"] { background: #c8e6c9; }
    .day[data-count="2"] { background: #81c784; }
    .day[data-count="3"] { background: #4caf50; }
    .day[data-count="4"] { background: #2e7d32; }
    .day[data-count="5"] { background: #1b5e20; }
    #settings { display:none; border:1px solid #aaa; padding:15px; margin-top:20px; border-radius:8px; background:#fafafa; }
  </style>
</head>
<body>
  <h1>🎯 Ambition Tracker Hybrid</h1>

  <label for="user-select">👤 User:</label>
  <select id="user-select"></select>
  <button id="add-user">➕ Add User</button>
  <button id="open-settings">⚙ Einstellungen</button>

  <!-- XP Bar -->
  <div class="xp-bar">
    <h2>XP Progress</h2>
    <div class="progress-bar">
      <div id="xp-bar-inner" class="progress-bar-inner"></div>
    </div>
    <p id="xp-info"></p>
    <p id="streak-info"></p>
    <div id="rewards"></div>
  </div>

  <!-- Goals -->
  <div id="dashboard"></div>
  <button id="add-goal">Add Goal</button>

  <!-- Heatmap -->
  <h2>📅 Aktivität</h2>
  <div id="heatmap" class="heatmap"></div>

  <!-- Settings -->
  <div id="settings">
    <h2>⚙ User Settings</h2>
    <label>Background Color: <input type="color" id="bg-color"></label>
    <button id="reset-user">Reset Progress</button>
    <button id="close-settings">Close</button>
  </div>

  <!-- Script -->
  <script type="module">
    // --- Firebase ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "DEIN_API_KEY",
      authDomain: "DEIN_PROJEKT.firebaseapp.com",
      projectId: "DEIN_PROJEKT_ID",
      storageBucket: "DEIN_PROJEKT.appspot.com",
      messagingSenderId: "DEINE_SENDER_ID",
      appId: "DEINE_APP_ID"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- Variablen ---
    const STORAGE_KEY = "ambition-tracker-users";
    const XP_PER_LEVEL = 10;
    let users = {};
    let currentUser = null;

    // --- LocalStorage ---
    function loadLocalUsers() {
      const saved = localStorage.getItem(STORAGE_KEY);
      users = saved ? JSON.parse(saved) : {};
    }
    function saveLocalUsers() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(users));
    }

    // --- Firestore ---
    async function loadUserFromCloud(username) {
      const ref = doc(db, "users", username);
      const snap = await getDoc(ref);
      if (snap.exists()) {
        users[username] = snap.data();
        saveLocalUsers();
        console.log("☁️ Daten aus Cloud geladen:", username);
      }
    }
    async function saveUserToCloud(username) {
      const ref = doc(db, "users", username);
      await setDoc(ref, users[username]);
    }

    // --- User Daten ---
    function createDefaultUser(username) {
      return {
        totalXP: 0,
        currentLevel: 1,
        rewards: [],
        goals: [{ id: 1, name: "Read 20 pages", target: 20, progress: 0, lastUpdate: null, decayRate: 0 }],
        streak: 0,
        lastActive: null,
        activityLog: {},
        settings: { bgColor: "#ffffff" }
      };
    }
    function getUserData(username) {
      if (!users[username]) {
        users[username] = createDefaultUser(username);
        saveLocalUsers();
      }
      return users[username];
    }

    // --- Logik ---
    function addXP(data, amount) {
      const today = new Date().toISOString().split("T")[0];
      if (data.lastActive) {
        const diff = (new Date(today) - new Date(data.lastActive)) / (1000*60*60*24);
        if (diff === 1) data.streak++;
        else if (diff > 1) data.streak = 1;
      } else {
        data.streak = 1;
      }
      data.lastActive = today;

      let multiplier = data.streak >= 5 ? 2 : 1;
      data.totalXP += amount * multiplier;
      data.activityLog[today] = (data.activityLog[today] || 0) + amount;

      const newLevel = Math.floor(data.totalXP / XP_PER_LEVEL) + 1;
      if (newLevel > data.currentLevel) {
        data.currentLevel = newLevel;
        data.rewards.push(`Level ${newLevel}`);
        alert(`🎉 Level ${newLevel} erreicht!`);
      }
    }
    function applyDecay(goal) {
      if (!goal.lastUpdate) return;
      const today = new Date().toISOString().split("T")[0];
      const diff = (new Date(today) - new Date(goal.lastUpdate)) / (1000*60*60*24);
      if (diff > 0 && goal.decayRate > 0) {
        goal.progress = Math.max(0, goal.progress - diff * goal.decayRate);
      }
    }

    // --- Render ---
    function renderXP() {
      const data = getUserData(currentUser);
      const xpInLevel = data.totalXP % XP_PER_LEVEL;
      const percent = (xpInLevel / XP_PER_LEVEL) * 100;
      document.getElementById("xp-bar-inner").style.width = percent + "%";
      document.getElementById("xp-info").innerText = `XP: ${xpInLevel} / ${XP_PER_LEVEL} (Level ${data.currentLevel})`;
      document.getElementById("streak-info").innerText = `🔥 Streak: ${data.streak} Tage`;
      document.getElementById("rewards").innerHTML = data.rewards.map(r => `<span class="badge">🏆 ${r}</span>`).join(" ");
      document.body.style.backgroundColor = data.settings.bgColor;
    }
    function renderGoals() {
      const data = getUserData(currentUser);
      const dash = document.getElementById("dashboard");
      dash.innerHTML = "";
      data.goals.forEach(goal => {
        applyDecay(goal);
        const div = document.createElement("div");
        div.className = "goal";
        div.innerHTML = `
          <h3>${goal.name}</h3>
          <p>Progress: ${Math.floor(goal.progress)} / ${goal.target}</p>
          <p>Decay Rate: ${goal.decayRate} pro Tag</p>
          <button onclick="progressGoal(${goal.id},1)">Minimum</button>
          <button onclick="progressGoal(${goal.id},2)">Normal</button>
          <button onclick="progressGoal(${goal.id},5)">Super gut</button>
        `;
        dash.appendChild(div);
      });
    }
    function renderHeatmap() {
      const data = getUserData(currentUser);
      const heatmap = document.getElementById("heatmap");
      heatmap.innerHTML = "";
      const today = new Date();
      for (let i=29; i>=0; i--) {
        const d = new Date(today);
        d.setDate(d.getDate()-i);
        const key = d.toISOString().split("T")[0];
        const count = data.activityLog[key] || 0;
        const div = document.createElement("div");
        div.className = "day";
        if (count>0) div.dataset.count = Math.min(count,5);
        heatmap.appendChild(div);
      }
    }
    function renderUserSelect() {
      const select = document.getElementById("user-select");
      select.innerHTML = "";
      Object.keys(users).forEach(u=>{
        const opt=document.createElement("option");
        opt.value=u; opt.textContent=u;
        if(u===currentUser) opt.selected=true;
        select.appendChild(opt);
      });
    }

    // --- Aktionen ---
    window.progressGoal = async function(goalId, amount){
      const data=getUserData(currentUser);
      const goal=data.goals.find(g=>g.id===goalId);
      goal.progress+=amount;
      goal.lastUpdate=new Date().toISOString().split("T")[0];
      addXP(data,amount);
      renderGoals(); renderXP(); renderHeatmap();
      saveLocalUsers();
      await saveUserToCloud(currentUser);
    }
    document.getElementById("add-goal").addEventListener("click",()=>{
      const data=getUserData(currentUser);
      const name=prompt("Goal name:");
      const target=parseInt(prompt("Target (units):"),10);
      const decay=parseInt(prompt("Decay per day (0 = none):"),10);
      if(name && target>0){
        const id=data.goals.length?data.goals[data.goals.length-1].id+1:1;
        data.goals.push({id,name,target,progress:0,lastUpdate:null,decayRate:decay});
        renderGoals(); saveLocalUsers(); saveUserToCloud(currentUser);
      }
    });

    // --- Settings ---
    document.getElementById("open-settings").addEventListener("click",()=>{
      document.getElementById("settings").style.display="block";
      document.getElementById("bg-color").value=getUserData(currentUser).settings.bgColor;
    });
    document.getElementById("close-settings").addEventListener("click",()=>{
      document.getElementById("settings").style.display="none";
    });
    document.getElementById("bg-color").addEventListener("input",e=>{
      getUserData(currentUser).settings.bgColor=e.target.value;
      renderXP(); saveLocalUsers(); saveUserToCloud(currentUser);
    });
    document.getElementById("reset-user").addEventListener("click",()=>{
      if(confirm("Reset progress for this user?")){
        users[currentUser]=createDefaultUser(currentUser);
        saveLocalUsers(); saveUserToCloud(currentUser);
        renderGoals(); renderXP(); renderHeatmap();
      }
    });

    // --- Init ---
    async function init(){
      loadLocalUsers();
      if(!Object.keys(users).length){
        users["User1"]=createDefaultUser("User1");
        currentUser="User1"; saveLocalUsers();
      } else {
        currentUser=Object.keys(users)[0];
      }
      await loadUserFromCloud(currentUser);
      renderUserSelect(); renderGoals(); renderXP(); renderHeatmap();
      document.getElementById("user-select").addEventListener("change",async e=>{
        currentUser=e.target.value;
        await loadUserFromCloud(currentUser);
        renderGoals(); renderXP(); renderHeatmap();
      });
      document.getElementById("add-user").addEventListener("click",()=>{
        const name=prompt("Neuer User:");
        if(name){
          users[name]=createDefaultUser(name);
          currentUser=name;
          saveLocalUsers(); saveUserToCloud(name);
          renderUserSelect(); renderGoals(); renderXP(); renderHeatmap();
        }
      });
    }
    init();
  </script>
</body>
</html>
